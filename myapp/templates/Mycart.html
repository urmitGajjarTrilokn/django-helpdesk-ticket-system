{% extends "Base.html" %}
{% block title %}Assigned Tickets - HelpDesk{% endblock %}

{% block breadcrumb %}
  <strong>Assigned Tickets</strong>
{% endblock %}

{% block extra_css %}
<style>
  .ticket-card {
    background: #fff;
    border: 1px solid var(--slate-200);
    border-radius: var(--r-lg);
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    transition: all .2s;
    overflow: hidden;
    height: 100%;
  }
  .ticket-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }

  .tc-header {
    padding: 14px 16px;
    border-bottom: 1px solid var(--slate-100);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    flex-wrap: wrap;
  }
  .tc-body { padding: 14px 16px; flex: 1; }
  .tc-footer {
    padding: 10px 16px;
    border-top: 1px solid var(--slate-100);
    background: var(--slate-50);
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .tc-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--slate-900);
    margin-bottom: 4px;
    line-height: 1.4;
  }
  .tc-meta { font-size: 12px; color: var(--slate-400); margin-bottom: 12px; }

  .tc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .tc-cell { background: var(--slate-50); border-radius: 7px; padding: 8px 10px; }
  .tc-cell-label {
    font-size: 9.5px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .6px;
    color: var(--slate-400);
    margin-bottom: 3px;
  }
  .tc-cell-val { font-size: 12.5px; font-weight: 600; color: var(--slate-800); }

  .my-filter-bar {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 20px;
  }
  .mf-pill {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12.5px;
    font-weight: 600;
    border: 1.5px solid var(--slate-200);
    background: #fff;
    color: var(--slate-600);
    cursor: pointer;
    transition: all .15s;
    text-decoration: none;
  }
  .mf-pill:hover,
  .mf-pill.active {
    border-color: var(--brand);
    color: var(--brand);
    background: var(--brand-light);
  }

  @media (max-width: 575px) {
    .tc-grid { grid-template-columns: 1fr; }
  }
</style>
{% endblock %}

{% block content %}
<div class="page-header d-flex align-items-center justify-content-between flex-wrap gap-3">
  <div>
    <div class="page-title">Assigned Tickets</div>
    <div class="page-sub">Tickets assigned to you in your departments.</div>
  </div>
  <a href="{{ dashboard_url|default:'/' }}" class="btn btn-outline-secondary btn-sm">
    <i class="fas fa-th-large me-1"></i>All Tickets
  </a>
</div>

{% if Carts %}

<div class="row g-3 mb-4">
  <div class="col-6 col-sm-4">
    <div class="stat-card">
      <div class="stat-icon si-indigo"><i class="fas fa-inbox"></i></div>
      <div>
        <div class="stat-label">Assigned</div>
        <div class="stat-value">{{ stats.assigned|default:0 }}</div>
      </div>
    </div>
  </div>
  <div class="col-6 col-sm-4">
    <div class="stat-card">
      <div class="stat-icon si-yellow"><i class="fas fa-spinner"></i></div>
      <div>
        <div class="stat-label">In Progress</div>
        <div class="stat-value">{{ stats.in_progress|default:0 }}</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-sm-4">
    <div class="stat-card">
      <div class="stat-icon si-red"><i class="fas fa-exclamation-circle"></i></div>
      <div>
        <div class="stat-label">Overdue</div>
        <div class="stat-value" style="color:var(--danger);">{{ stats.overdue|default:0 }}</div>
      </div>
    </div>
  </div>
</div>

<div class="my-filter-bar" id="filterPills">
  <a href="?sort={{ sort|default:'all' }}" class="mf-pill {% if not selected_department_filter %}active{% endif %}">All Departments</a>
  {% if user_departments|length > 1 %}
    {% for dept in user_departments %}
    <a href="?sort={{ sort|default:'all' }}&department={{ dept.id }}"
       class="mf-pill {% if selected_department_filter == dept.id|stringformat:'s' %}active{% endif %}">
      {{ dept.name }}
    </a>
    {% endfor %}
  {% endif %}
</div>

<div class="my-filter-bar" id="sortPills">
  <a href="?sort=all{% if selected_department_filter %}&department={{ selected_department_filter }}{% endif %}" class="mf-pill {% if sort == 'all' %}active{% endif %}">All</a>
  <a href="?sort=urgent{% if selected_department_filter %}&department={{ selected_department_filter }}{% endif %}" class="mf-pill {% if sort == 'urgent' %}active{% endif %}">Urgent</a>
  <a href="?sort=overdue{% if selected_department_filter %}&department={{ selected_department_filter }}{% endif %}" class="mf-pill {% if sort == 'overdue' %}active{% endif %}">Overdue</a>
</div>

<div class="row g-3">
  {% for cart in Carts %}
  <div class="col-12 col-md-6 col-xl-4" data-overdue="{{ cart.task.is_overdue|yesno:'true,false' }}" data-priority="{{ cart.task.priority|lower }}">
    <div class="ticket-card">
      <div class="tc-header">
        <div class="d-flex align-items-center gap-2">
          <span class="mono" style="font-size:11.5px;color:var(--slate-400);">#{{ cart.task.id }}</span>
          <span class="status-badge
            {% if cart.task.TASK_STATUS == 'Open' %}sb-open
            {% elif cart.task.TASK_STATUS == 'In Progress' %}sb-progress
            {% elif cart.task.TASK_STATUS == 'Reopen' %}sb-reopen
            {% else %}sb-closed{% endif %}">
            {{ cart.task.TASK_STATUS }}
          </span>
        </div>
        {% if cart.task.priority %}
        <span class="priority-badge
          {% if cart.task.priority == 'LOW' %}pb-low
          {% elif cart.task.priority == 'MEDIUM' %}pb-medium
          {% elif cart.task.priority == 'HIGH' %}pb-high
          {% else %}pb-urgent{% endif %}">
          {{ cart.task.get_priority_display }}
        </span>
        {% endif %}
      </div>

      <div class="tc-body">
        <div class="tc-title">{{ cart.task.TASK_TITLE|truncatechars:65 }}</div>
        <div class="tc-meta">
          <i class="fas fa-user" style="font-size:10px;"></i> {{ cart.task.TASK_CREATED.username }}
          {% if cart.task.assigned_department %}
          &nbsp;|&nbsp;<i class="fas fa-building" style="font-size:10px;"></i> {{ cart.task.assigned_department.name }}
          {% endif %}
        </div>

        <div class="tc-grid">
          <div class="tc-cell">
            <div class="tc-cell-label">Due Date</div>
            <div class="tc-cell-val {% if cart.task.is_overdue %}text-danger{% endif %}">
              {{ cart.task.TASK_DUE_DATE|date:"M d, Y" }}
            </div>
          </div>

          {% if cart.task.category %}
          <div class="tc-cell">
            <div class="tc-cell-label">Category</div>
            <div class="tc-cell-val" style="color:{{ cart.task.category.color }};">{{ cart.task.category.name }}</div>
          </div>
          {% endif %}

          {% if cart.accepted_at %}
          <div class="tc-cell">
            <div class="tc-cell-label">Assigned At</div>
            <div class="tc-cell-val">{{ cart.accepted_at|date:"M d, H:i" }}</div>
          </div>
          {% endif %}
        </div>
      </div>

      <div class="tc-footer">
        <a href="{% url 'taskinfo' cart.task.id %}?from_assigned=1" class="btn btn-xs btn-outline-secondary flex-fill text-center">
          <i class="fas fa-eye"></i> View
        </a>

        {% if cart.task.TASK_STATUS == 'In Progress' %}
        <a href="{% url 'resolvedtask' cart.task.id %}" class="btn btn-xs btn-success" title="Mark as Resolved">
          <i class="fas fa-check-circle"></i>
        </a>
        <a href="{% url 'comment' pk=cart.task.id action='closing_comment' %}" class="btn btn-xs btn-outline-success" title="Close with Note">
          <i class="fas fa-check"></i>
        </a>
        {% endif %}

        {% if cart.task.id not in non_rejectable_task_ids and cart.task.TASK_STATUS != 'Reopen' %}
        <a href="{% url 'removetask' cart.task.id %}" class="btn btn-xs btn-outline-danger" title="Reject this assignment">
          <i class="fas fa-times"></i>
        </a>
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

{% else %}
<div class="hd-card">
  <div class="empty-state" style="padding:64px 32px;">
    <div class="empty-icon"><i class="fas fa-inbox" style="color:var(--slate-300);"></i></div>
    <div class="empty-title">No tickets assigned</div>
    <div class="empty-text">You currently have no assigned tickets.</div>
    <a href="{{ dashboard_url|default:'/' }}" class="btn btn-sm btn-primary">
      <i class="fas fa-th-large me-1"></i>Browse All Tickets
    </a>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}{% endblock %}
