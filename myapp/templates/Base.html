{% load avatar_tags %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}HelpDesk{% endblock %}</title>

  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root {
      --brand:        #0F766E;
      --brand-dark:   #115E59;
      --brand-light:  #ECFEFF;
      --brand-muted:  #99F6E4;

      --success:      #059669; --success-bg: #ECFDF5; --success-border: #6EE7B7;
      --warning:      #D97706; --warning-bg: #FFFBEB; --warning-border: #FCD34D;
      --danger:       #DC2626; --danger-bg:  #FEF2F2; --danger-border:  #FECACA;
      --info:         #0284C7; --info-bg:    #F0F9FF; --info-border:    #BAE6FD;

      --slate-50:  #F8FAFC; --slate-100: #F1F5F9; --slate-200: #E2E8F0;
      --slate-300: #CBD5E1; --slate-400: #94A3B8; --slate-500: #64748B;
      --slate-600: #475569; --slate-700: #334155; --slate-800: #1E293B;
      --slate-900: #0F172A;

      --sidebar-w: 252px;
      --topbar-h:  60px;
      --r:         8px;
      --r-lg:      12px;
      --shadow:    0 4px 14px rgba(15,23,42,.05);
      --shadow-md: 0 10px 28px rgba(15,23,42,.08);
      --shadow-lg: 0 18px 44px rgba(15,23,42,.12);
      --t:         all .15s ease;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      line-height: 1.55;
      color: var(--slate-800);
      background:
        radial-gradient(1200px 600px at 90% -10%, #dbeafe 0%, transparent 42%),
        radial-gradient(900px 500px at -10% 12%, #ccfbf1 0%, transparent 36%),
        var(--slate-50);
    }
    a { text-decoration: none; color: inherit; }
    .mono { font-family: 'IBM Plex Mono', monospace; }

    body.role-user    .agent-only  { display: none !important; }
    body.role-user    .admin-only  { display: none !important; }

    .hd-sidebar {
      position: fixed;
      top: 0; left: 0; bottom: 0;
      width: var(--sidebar-w);
      background: rgba(255,255,255,.92);
      border-right: 1px solid var(--slate-200);
      backdrop-filter: blur(8px);
      display: flex;
      flex-direction: column;
      z-index: 300;
      transition: transform .25s ease;
    }
    .hd-sidebar-inner { display: flex; flex-direction: column; height: 100%; overflow: hidden; }

    .hd-logo {
      height: var(--topbar-h);
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 20px;
      border-bottom: 1px solid var(--slate-100);
      flex-shrink: 0;
    }
    .hd-logo-mark {
      width: 34px; height: 34px;
      background: var(--brand);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px; color: #fff; flex-shrink: 0;
    }
    .hd-logo-text { font-size: 15px; font-weight: 700; color: var(--slate-900); letter-spacing: -.3px; }
    .hd-logo-sub  { font-size: 10px; color: var(--slate-400); margin-top: 1px; }

    .hd-nav {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
      scrollbar-width: none;
    }
    .hd-nav::-webkit-scrollbar { display: none; }

    .nav-section {
      padding: 12px 20px 4px;
      font-size: 9.5px; font-weight: 700;
      letter-spacing: 1px; text-transform: uppercase;
      color: var(--slate-400);
    }

    .nav-item {
      display: flex; align-items: center; gap: 10px;
      padding: 8.5px 14px;
      margin: 1px 10px;
      border-radius: var(--r);
      color: var(--slate-600);
      font-size: 13.5px; font-weight: 500;
      transition: var(--t);
      position: relative;
      cursor: pointer;
    }
    .nav-item:hover  { background: var(--slate-100); color: var(--slate-900); }
    .nav-item.active { background: var(--brand-light); color: var(--brand-dark); font-weight: 700; }
    .nav-item.active::before {
      content: '';
      position: absolute; left: -10px; top: 6px; bottom: 6px;
      width: 3px; background: var(--brand); border-radius: 0 3px 3px 0;
    }
    .nav-icon { width: 18px; text-align: center; font-size: 13px; flex-shrink: 0; }
    .nav-badge {
      margin-left: auto;
      background: var(--danger); color: #fff;
      font-size: 9.5px; font-weight: 700;
      min-width: 18px; padding: 1px 5px;
      border-radius: 20px; text-align: center;
    }
    .nav-badge-dot {
      margin-left: auto;
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--brand);
    }

    .hd-sidebar-footer {
      padding: 12px;
      border-top: 1px solid var(--slate-100);
      flex-shrink: 0;
    }
    .hd-user-row {
      display: flex; align-items: center; gap: 10px;
      padding: 8px 10px;
      border-radius: var(--r);
      transition: var(--t);
    }
    .hd-user-row:hover { background: var(--slate-100); }
    .hd-avatar {
      width: 34px; height: 34px;
      border-radius: 50%;
      background: var(--brand);
      color: #fff; font-size: 13px; font-weight: 700;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; overflow: hidden;
    }
    .hd-avatar img  { width: 100%; height: 100%; object-fit: cover; }
    .hd-user-name   { font-size: 13px; font-weight: 600; color: var(--slate-800); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .hd-user-role   { font-size: 10.5px; color: var(--slate-400); text-transform: uppercase; letter-spacing: .5px; }
    .hd-signout {
      display: flex; align-items: center; gap: 10px;
      padding: 7px 14px; margin-top: 3px;
      border-radius: var(--r);
      color: var(--slate-500);
      font-size: 13px; font-weight: 500;
      transition: var(--t);
    }
    .hd-signout:hover { color: var(--danger); background: var(--danger-bg); }

    .hd-topbar {
      position: fixed;
      top: 0; left: var(--sidebar-w); right: 0;
      height: var(--topbar-h);
      background: rgba(255,255,255,.88);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--slate-200);
      display: flex; align-items: center;
      padding: 0 24px; gap: 12px;
      z-index: 200;
    }
    .hd-toggle { display: none; background: none; border: none; color: var(--slate-500); font-size: 18px; cursor: pointer; padding: 4px; }

    .hd-breadcrumb {
      flex: 1;
      font-size: 13px; color: var(--slate-500);
      display: flex; align-items: center; gap: 6px;
    }
    .bc-sep { color: var(--slate-300); }
    .hd-breadcrumb strong { color: var(--slate-800); font-weight: 600; }
    .hd-breadcrumb a { color: var(--slate-500); transition: var(--t); }
    .hd-breadcrumb a:hover { color: var(--brand); }

    .topbar-actions { display: flex; align-items: center; gap: 6px; }
    .topbar-btn {
      position: relative;
      width: 36px; height: 36px;
      border-radius: var(--r);
      background: #fff;
      border: 1px solid var(--slate-200);
      border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: var(--slate-600); font-size: 14px;
      transition: var(--t);
      text-decoration: none;
    }
    .topbar-btn:hover { background: var(--slate-50); color: var(--slate-800); border-color: var(--slate-300); }
    .topbar-btn.active { background: var(--brand-light); color: var(--brand); }
    .notif-dot {
      position: absolute; top: 6px; right: 6px;
      width: 8px; height: 8px;
      background: var(--danger); border-radius: 50%;
      border: 2px solid #fff;
    }

    .hd-main {
      position: relative;
      margin-left: var(--sidebar-w);
      margin-top: var(--topbar-h);
      padding: 24px;
      min-height: calc(100vh - var(--topbar-h));
      width: calc(100% - var(--sidebar-w));
      max-width: 100%;
      overflow-x: hidden;
    }

    .hd-card {
      background: rgba(255,255,255,.96);
      border: 1px solid var(--slate-200);
      border-radius: 14px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .hd-card-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--slate-100);
    }
    .hd-card-title { font-size: 14px; font-weight: 700; color: var(--slate-800); display: flex; align-items: center; gap: 8px; }
    .hd-card-body  { padding: 20px; }
    .hd-card-footer {
      padding: 12px 20px;
      border-top: 1px solid var(--slate-100);
      background: var(--slate-50);
    }

    .stat-card {
      background: rgba(255,255,255,.95);
      border: 1px solid var(--slate-200);
      border-radius: 14px;
      padding: 18px 20px;
      display: flex; align-items: center; gap: 16px;
      box-shadow: var(--shadow);
      transition: var(--t);
    }
    .stat-card:hover { box-shadow: var(--shadow-md); transform: translateY(-1px); }
    .stat-icon {
      width: 44px; height: 44px;
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; flex-shrink: 0;
    }
    .si-indigo  { background: var(--brand-light);  color: var(--brand); }
    .si-green   { background: var(--success-bg);    color: var(--success); }
    .si-yellow  { background: var(--warning-bg);    color: var(--warning); }
    .si-red     { background: var(--danger-bg);     color: var(--danger); }
    .si-blue    { background: var(--info-bg);       color: var(--info); }
    .si-slate   { background: var(--slate-100);     color: var(--slate-600); }
    .stat-label { font-size: 11.5px; color: var(--slate-500); font-weight: 500; text-transform: uppercase; letter-spacing: .5px; }
    .stat-value { font-size: 26px; font-weight: 700; color: var(--slate-900); line-height: 1.15; margin-top: 1px; }
    .stat-meta  { font-size: 11.5px; color: var(--slate-400); margin-top: 2px; }

    .status-badge {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 3px 10px; border-radius: 20px;
      font-size: 11.5px; font-weight: 700;
      letter-spacing: .2px;
    }
    .sb-open     { background: #EFF6FF; color: #1D4ED8; border: 1px solid #BFDBFE; }
    .sb-progress { background: #FFFBEB; color: #B45309; border: 1px solid #FDE68A; }
    .sb-closed   { background: var(--slate-100); color: var(--slate-600); border: 1px solid var(--slate-200); }
    .sb-resolved { background: var(--success-bg); color: var(--success); border: 1px solid var(--success-border); }
    .sb-reopen   { background: #FFF7ED; color: #C2410C; border: 1px solid #FDBA74; }
    .sb-expired  { background: var(--danger-bg); color: var(--danger); border: 1px solid var(--danger-border); }

    .priority-badge {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 3px 9px; border-radius: 4px;
      font-size: 11px; font-weight: 700; letter-spacing: .3px;
    }
    .pb-low    { background: var(--success-bg); color: var(--success); }
    .pb-medium { background: var(--info-bg);    color: var(--info); }
    .pb-high   { background: var(--warning-bg); color: var(--warning); }
    .pb-urgent { background: var(--danger-bg);  color: var(--danger); }

    .btn-primary {
      background: var(--brand); border-color: var(--brand);
      font-weight: 600; font-family: 'DM Sans', sans-serif;
    }
    .btn-primary:hover { background: var(--brand-dark); border-color: var(--brand-dark); }
    .btn-xs { padding: 4px 10px; font-size: 12px; }

    .form-control, .form-select {
      font-family: 'DM Sans', sans-serif;
      font-size: 13.5px;
      border-color: var(--slate-300);
      border-radius: var(--r);
      padding: 9px 12px;
      transition: var(--t);
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(79,70,229,.12);
    }
    .form-control.is-invalid { border-color: var(--danger); }
    .js-invalid-feedback {
      display: block;
      margin-top: 4px;
      font-size: 12px;
      color: var(--danger);
      font-weight: 500;
    }
    .form-label { font-size: 13px; font-weight: 600; color: var(--slate-700); margin-bottom: 5px; }
    .field-error { font-size: 12px; color: var(--danger); margin-top: 4px; }

    #toast-container {
      position: fixed; bottom: 24px; right: 24px;
      z-index: 9999; display: flex; flex-direction: column; gap: 10px;
    }
    .hd-toast {
      display: flex; align-items: flex-start; gap: 12px;
      background: var(--slate-900); color: #fff;
      padding: 14px 16px; border-radius: var(--r-lg);
      box-shadow: var(--shadow-lg);
      min-width: 280px; max-width: 380px;
      animation: slideUp .25s ease;
    }
    .hd-toast-success { border-left: 4px solid var(--success); }
    .hd-toast-danger  { border-left: 4px solid var(--danger); }
    .hd-toast-warning { border-left: 4px solid var(--warning); }
    .hd-toast-info    { border-left: 4px solid var(--info); }
    .hd-toast-body    { flex: 1; font-size: 13.5px; line-height: 1.45; }
    .toast-close {
      background: none; border: none; color: rgba(255,255,255,.4);
      font-size: 18px; cursor: pointer; line-height: 1;
      padding: 0; flex-shrink: 0;
    }
    .toast-close:hover { color: #fff; }
    @keyframes slideUp { from { transform: translateY(16px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .notif-drawer {
      position: fixed; top: 0; right: 0; bottom: 0;
      width: 380px;
      background: #fff;
      box-shadow: -4px 0 32px rgba(0,0,0,.12);
      z-index: 1100;
      display: flex; flex-direction: column;
      transform: translateX(100%);
      transition: transform .28s cubic-bezier(.4,0,.2,1);
    }
    .notif-drawer.open { transform: translateX(0); }
    .drawer-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.3);
      z-index: 1099;
      opacity: 0; pointer-events: none;
      transition: opacity .28s ease;
    }
    .drawer-overlay.open { opacity: 1; pointer-events: all; }

    .notif-drawer-head {
      display: flex; align-items: center; justify-content: space-between;
      padding: 18px 20px;
      border-bottom: 1px solid var(--slate-200);
      flex-shrink: 0;
    }
    .notif-drawer-title { font-size: 15px; font-weight: 700; color: var(--slate-900); }
    .notif-drawer-close {
      background: none; border: none;
      color: var(--slate-400); font-size: 18px;
      cursor: pointer; padding: 4px;
      transition: var(--t); border-radius: 6px;
    }
    .notif-drawer-close:hover { background: var(--slate-100); color: var(--slate-700); }

    .notif-drawer-tabs {
      display: flex;
      border-bottom: 1px solid var(--slate-200);
      flex-shrink: 0;
    }
    .nd-tab {
      flex: 1; padding: 10px 16px;
      font-size: 13px; font-weight: 600;
      color: var(--slate-500);
      border-bottom: 2px solid transparent;
      cursor: pointer; text-align: center;
      transition: var(--t); background: none; border-top: none; border-left: none; border-right: none;
    }
    .nd-tab.active { color: var(--brand); border-bottom-color: var(--brand); }
    .nd-tab:hover { color: var(--slate-800); }

    .notif-drawer-body { flex: 1; overflow-y: auto; }
    .notif-drawer-footer {
      padding: 12px 20px;
      border-top: 1px solid var(--slate-100);
      display: flex; gap: 8px; flex-shrink: 0;
    }

    .nd-item {
      display: flex; align-items: flex-start; gap: 12px;
      padding: 14px 20px;
      border-bottom: 1px solid var(--slate-100);
      transition: background .12s;
      cursor: pointer;
    }
    .nd-item:hover  { background: var(--slate-50); }
    .nd-item.unread { background: #F5F7FF; }
    .nd-item.unread:hover { background: #EEF1FF; }
    .nd-item:last-child { border-bottom: none; }
    .nd-icon {
      width: 36px; height: 36px;
      border-radius: 9px; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px;
    }
    .nd-content { flex: 1; min-width: 0; }
    .nd-msg  { font-size: 13px; color: var(--slate-800); line-height: 1.45; }
    .nd-msg.bold { font-weight: 600; }
    .nd-time { font-size: 11.5px; color: var(--slate-400); margin-top: 3px; }
    .nd-unread-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--brand); flex-shrink: 0; margin-top: 5px;
    }

    .page-header { margin-bottom: 24px; }
    .page-title  { font-size: 22px; font-weight: 700; color: var(--slate-900); letter-spacing: -.3px; }
    .page-sub    { font-size: 13.5px; color: var(--slate-500); margin-top: 3px; }

    .hd-table { width: 100%; border-collapse: collapse; }
    .hd-table th {
      font-size: 11.5px; font-weight: 700;
      color: var(--slate-500); text-transform: uppercase; letter-spacing: .6px;
      padding: 10px 16px; border-bottom: 1px solid var(--slate-200);
      background: var(--slate-50); white-space: nowrap;
    }
    .hd-table td {
      padding: 13px 16px;
      border-bottom: 1px solid var(--slate-100);
      vertical-align: middle; font-size: 13.5px;
    }
    .hd-table tr:last-child td { border-bottom: none; }
    .hd-table tbody tr:hover  { background: var(--slate-50); }

    .empty-state  { text-align: center; padding: 60px 32px; }
    .empty-icon   { font-size: 36px; color: var(--slate-300); margin-bottom: 16px; }
    .empty-title  { font-size: 16px; font-weight: 700; color: var(--slate-700); margin-bottom: 6px; }
    .empty-text   { font-size: 13.5px; color: var(--slate-400); max-width: 340px; margin: 0 auto 20px; }

    .ai-badge {
      display: inline-flex; align-items: center; gap: 5px;
      background: linear-gradient(135deg, #0f766e, #0284c7);
      color: #fff; font-size: 10.5px; font-weight: 700;
      padding: 2px 8px; border-radius: 20px;
      letter-spacing: .3px;
    }

    .hd-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,.45); z-index: 299;
    }

    @media (max-width: 991px) {
      .hd-sidebar { transform: translateX(-100%); }
      .hd-sidebar.open { transform: translateX(0); }
      .hd-overlay { display: block; opacity: 0; pointer-events: none; transition: opacity .25s; }
      .hd-overlay.show { opacity: 1; pointer-events: all; }

      .hd-main {
        margin-left: 0;
        width: 100%;
        padding: 20px 16px 48px;
      }

      .hd-topbar { left: 0; }
      .hd-toggle { display: block; }
    }

    @media (max-width: 480px) {
      .notif-drawer { width: 100%; }
    }

    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--slate-300); border-radius: 4px; }
  </style>

  {% block extra_css %}{% endblock %}
</head>

<body class="{% if request.user.is_authenticated %}{% if is_admin %}role-admin{% else %}role-user{% endif %}{% endif %}">

<div class="hd-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

{% if not is_admin %}
<div class="drawer-overlay" id="drawerOverlay" onclick="closeNotifDrawer()"></div>
<div class="notif-drawer" id="notifDrawer">
  <div class="notif-drawer-head">
    <div class="notif-drawer-title">
      <i class="fas fa-bell me-2" style="color:var(--brand);"></i>Notifications
      {% if unread_notifications > 0 %}
      <span style="background:var(--danger);color:#fff;font-size:10px;font-weight:700;
                   padding:1px 6px;border-radius:20px;margin-left:6px;">
        {{ unread_notifications }}
      </span>
      {% endif %}
    </div>
    <button class="notif-drawer-close" onclick="closeNotifDrawer()">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="notif-drawer-tabs">
    <button class="nd-tab active" onclick="filterNotif(this,'all')">All</button>
    <button class="nd-tab" onclick="filterNotif(this,'unread')">Unread</button>
    <button class="nd-tab" onclick="filterNotif(this,'read')">Read</button>
  </div>
  <div class="notif-drawer-body" id="notifDrawerBody">
    {% if recent_notifications %}
      {% for notif in recent_notifications %}
      <div class="nd-item {% if not notif.is_read %}unread{% endif %}"
           data-read="{{ notif.is_read|yesno:'true,false' }}"
           onclick="window.location='{% if notif.task %}{% url 'taskinfo' notif.task.id %}?mark_read={{ notif.id }}{% else %}{% url 'notifications_list' %}{% endif %}'">
        <div class="nd-icon
          {% if notif.notification_type == 'TASK_CREATED' %}si-indigo
          {% elif notif.notification_type == 'TASK_ASSIGNED' %}si-blue
          {% elif notif.notification_type == 'TASK_CLOSED' or notif.notification_type == 'TASK_RESOLVED' %}si-green
          {% elif notif.notification_type == 'TASK_OVERDUE' %}si-red
          {% else %}si-slate{% endif %}">
          <i class="fas
            {% if notif.notification_type == 'TASK_CREATED' %}fa-plus-circle
            {% elif notif.notification_type == 'TASK_ASSIGNED' %}fa-user-check
            {% elif notif.notification_type == 'TASK_CLOSED' %}fa-times-circle
            {% elif notif.notification_type == 'TASK_RESOLVED' %}fa-check-circle
            {% elif notif.notification_type == 'TASK_COMMENTED' %}fa-comment
            {% elif notif.notification_type == 'TASK_OVERDUE' %}fa-exclamation-circle
            {% else %}fa-bell{% endif %}">
          </i>
        </div>
        <div class="nd-content">
          <div class="nd-msg {% if not notif.is_read %}bold{% endif %}">{{ notif.message }}</div>
          <div class="nd-time"><i class="fas fa-clock me-1"></i>{{ notif.created_at|timesince }} ago</div>
        </div>
        {% if not notif.is_read %}<div class="nd-unread-dot"></div>{% endif %}
      </div>
      {% endfor %}
    {% else %}
      <div class="empty-state" style="padding:40px 20px;">
        <div class="empty-icon"><i class="fas fa-bell-slash"></i></div>
        <div class="empty-title">All caught up!</div>
        <div class="empty-text">No notifications yet.</div>
      </div>
    {% endif %}
  </div>
  <div class="notif-drawer-footer">
    {% if unread_notifications > 0 %}
    <a href="{% url 'mark_all_read' %}?next=base"
       class="btn btn-sm btn-outline-secondary flex-fill text-center">
      <i class="fas fa-check-double"></i> Mark All Read
    </a>
    {% endif %}
    <a href="{% url 'notifications_list' %}" class="btn btn-sm btn-primary flex-fill text-center">
      View All
    </a>
  </div>
</div>
{% endif %}

<aside class="hd-sidebar" id="sidebar">
  <div class="hd-sidebar-inner">

    <a href="{{ dashboard_url|default:'/' }}" class="hd-logo">
      <div class="hd-logo-mark"><i class="fas fa-headset"></i></div>
      <div>
        <div class="hd-logo-text">HelpDesk</div>
        <div class="hd-logo-sub">AI-Powered Support</div>
      </div>
    </a>

    <nav class="hd-nav">
      {% if request.user.is_authenticated %}

      <div class="nav-section">Workspace</div>

      <a href="{{ dashboard_url|default:'/' }}"
         class="nav-item {% if request.resolver_match.url_name == 'base' or request.resolver_match.url_name == 'base_department' %}active{% endif %}">
        <i class="nav-icon fas fa-th-large"></i> Dashboard
      </a>

      {% if is_admin %}
      <a href="{% url 'taskdetail' %}"
         class="nav-item {% if request.resolver_match.url_name == 'taskdetail' %}active{% endif %}">
        <i class="nav-icon fas fa-plus-circle"></i> New Ticket
      </a>
      <a href="{% url 'analytics_dashboard' %}"
         class="nav-item {% if request.resolver_match.url_name == 'analytics_dashboard' %}active{% endif %}">
        <i class="nav-icon fas fa-chart-bar"></i> Analytics
      </a>
      <a href="{% url 'pie_chart' %}"
         class="nav-item {% if request.resolver_match.url_name == 'pie_chart' %}active{% endif %}">
        <i class="nav-icon fas fa-chart-pie"></i> Charts
      </a>
      <a href="{% url 'admin_department_list' %}"
         class="nav-item {% if request.resolver_match.url_name == 'admin_department_list' %}active{% endif %}">
        <i class="nav-icon fas fa-users-cog"></i> Department Control
      </a>
      {% else %}
      <a href="{% url 'taskdetail' %}"
         class="nav-item {% if request.resolver_match.url_name == 'taskdetail' %}active{% endif %}">
        <i class="nav-icon fas fa-plus-circle"></i> New Ticket
      </a>
      <a href="{% url 'mycart' %}"
         class="nav-item {% if request.resolver_match.url_name == 'mycart' %}active{% endif %}">
        <i class="nav-icon fas fa-inbox"></i> Assigned Tickets
        {% if my_cart_count > 0 %}<span class="nav-badge">{{ my_cart_count }}</span>{% endif %}
      </a>
      <a href="{% url 'resolved_history' %}"
         class="nav-item {% if request.resolver_match.url_name == 'resolved_history' %}active{% endif %}">
        <i class="nav-icon fas fa-history"></i> Resolved History
      </a>
      {% if my_department_url %}
      <a href="{{ my_department_url }}"
         class="nav-item {% if request.resolver_match.url_name == 'department_members' or request.resolver_match.url_name == 'department_members_id' %}active{% endif %}">
        <i class="nav-icon fas fa-building"></i> My Department
      </a>
      {% endif %}
      {% endif %}

      <div class="nav-section">Account</div>
      {% if not is_admin %}
      <a href="{% url 'notifications_list' %}"
         class="nav-item {% if request.resolver_match.url_name == 'notifications_list' %}active{% endif %}">
        <i class="nav-icon fas fa-bell"></i> Notifications
        {% if unread_notifications > 0 %}
        <span class="nav-badge">{{ unread_notifications }}</span>
        {% endif %}
      </a>
      {% endif %}
      <a href="{% url 'profile' %}"
         class="nav-item {% if request.resolver_match.url_name == 'profile' %}active{% endif %}">
        <i class="nav-icon fas fa-user-circle"></i> My Profile
      </a>
      {% if is_admin %}
      <a href="{% url 'category_list' %}"
         class="nav-item {% if request.resolver_match.url_name == 'category_list' %}active{% endif %}">
        <i class="nav-icon fas fa-tags"></i> Categories
      </a>
      {% endif %}

      {% endif %}
    </nav>

    {% if request.user.is_authenticated %}
    <div class="hd-sidebar-footer">
      <a href="{% url 'profile' %}" class="hd-user-row">
        <div class="hd-avatar">
          {% with avatar=request.user|avatar_url %}
            {% if avatar %}
              <img src="{{ avatar }}" alt="">
            {% else %}
              {{ request.user|avatar_initial }}
            {% endif %}
          {% endwith %}
        </div>
        <div style="flex:1;min-width:0;">
          <div class="hd-user-name">{{ request.user.get_full_name|default:request.user.username }}</div>
          <div class="hd-user-role">{{ user_role|default:'User' }}</div>
        </div>
      </a>
      <a href="{% url 'logout' %}" class="hd-signout">
        <i class="nav-icon fas fa-sign-out-alt"></i> Sign Out
      </a>
    </div>
    {% endif %}

  </div>
</aside>

<header class="hd-topbar">
  <button class="hd-toggle" onclick="openSidebar()">
    <i class="fas fa-bars"></i>
  </button>

  <div class="hd-breadcrumb">
    {% block breadcrumb %}<strong>Dashboard</strong>{% endblock %}
  </div>

  {% if request.user.is_authenticated %}
  <div class="topbar-actions">

    <a href="{% url 'taskdetail' %}" class="topbar-btn" title="New Ticket">
      <i class="fas fa-plus"></i>
    </a>

    {% if not is_admin %}
    <a href="{% url 'notifications_list' %}" class="topbar-btn {% if unread_notifications > 0 %}active{% endif %}"
            title="Notifications" id="notifBtn">
      <i class="fas fa-bell"></i>
      {% if unread_notifications > 0 %}<span class="notif-dot"></span>{% endif %}
    </a>
    {% endif %}

    <div class="dropdown">
      <div class="hd-avatar" style="cursor:pointer;" data-bs-toggle="dropdown">
        {% with avatar=request.user|avatar_url %}
          {% if avatar %}
            <img src="{{ avatar }}" alt="">
          {% else %}
            {{ request.user|avatar_initial }}
          {% endif %}
        {% endwith %}
      </div>
      <ul class="dropdown-menu dropdown-menu-end"
          style="min-width:200px;border-color:var(--slate-200);border-radius:var(--r-lg);
                 font-size:13.5px;padding:6px;box-shadow:var(--shadow-md);">
        <li class="px-3 py-2" style="border-bottom:1px solid var(--slate-100);">
          <div style="font-weight:700;color:var(--slate-900);">{{ request.user.get_full_name|default:request.user.username }}</div>
          <div style="font-size:11px;color:var(--slate-400);">{{ request.user.email }}</div>
          <div style="margin-top:4px;">
            <span class="ai-badge"><i class="fas fa-robot"></i> AI-Assigned</span>
          </div>
        </li>
        <li class="mt-1">
          <a class="dropdown-item rounded" href="{% url 'profile' %}" style="padding:7px 12px;">
            <i class="fas fa-user me-2" style="color:var(--slate-400);width:14px;"></i>My Profile
          </a>
        </li>
        <li>
          <a class="dropdown-item rounded" href="{% url 'ChangePassword' %}" style="padding:7px 12px;">
            <i class="fas fa-key me-2" style="color:var(--slate-400);width:14px;"></i>Change Password
          </a>
        </li>
        <li><hr class="dropdown-divider my-1"></li>
        <li>
          <a class="dropdown-item rounded text-danger" href="{% url 'logout' %}" style="padding:7px 12px;">
            <i class="fas fa-sign-out-alt me-2" style="width:14px;"></i>Sign Out
          </a>
        </li>
      </ul>
    </div>

  </div>
  {% endif %}
</header>

<div id="toast-container">
  {% for message in messages %}
  <div class="hd-toast hd-toast-{{ message.tags }}">
    <i class="fas mt-1" style="flex-shrink:0;"></i>
    <div class="hd-toast-body">{{ message }}</div>
    <button class="toast-close" onclick="this.closest('.hd-toast').remove()">Ã—</button>
  </div>
  {% endfor %}
</div>

<main class="hd-main">
  {% block content %}{% endblock %}
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
  function openSidebar()  {
    document.getElementById('sidebar').classList.add('open');
    document.getElementById('sidebarOverlay').classList.add('show');
  }
  function closeSidebar() {
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('sidebarOverlay').classList.remove('show');
  }

  function openNotifDrawer() {
    const drawer = document.getElementById('notifDrawer');
    const overlay = document.getElementById('drawerOverlay');
    if (!drawer || !overlay) return;
    drawer.classList.add('open');
    overlay.classList.add('open');
    document.body.style.overflow = 'hidden';
  }
  function closeNotifDrawer() {
    const drawer = document.getElementById('notifDrawer');
    const overlay = document.getElementById('drawerOverlay');
    if (!drawer || !overlay) return;
    drawer.classList.remove('open');
    overlay.classList.remove('open');
    document.body.style.overflow = '';
  }

  function filterNotif(btn, type) {
    document.querySelectorAll('.nd-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.nd-item').forEach(item => {
      const isRead = item.dataset.read === 'true';
      if (type === 'all')    item.style.display = '';
      if (type === 'unread') item.style.display = isRead    ? 'none' : '';
      if (type === 'read')   item.style.display = !isRead   ? 'none' : '';
    });
  }

  document.querySelectorAll('.hd-toast').forEach(t => {
    setTimeout(() => { t.style.transition = 'opacity .4s'; t.style.opacity = '0'; }, 4500);
    setTimeout(() => t.remove(), 4900);
  });

  document.querySelectorAll('.hd-toast .fas.mt-1').forEach(el => {
    const parent = el.closest('.hd-toast');
    if      (parent.classList.contains('hd-toast-success')) el.classList.add('fa-check-circle');
    else if (parent.classList.contains('hd-toast-danger'))  el.classList.add('fa-exclamation-circle');
    else if (parent.classList.contains('hd-toast-warning')) el.classList.add('fa-exclamation-triangle');
    else                                                     el.classList.add('fa-info-circle');
  });

  (function setupSharedFormValidation() {
    const excludedForms = new Set([
      'registerForm', 'pwForm', 'editForm', 'commentForm',
      'editProfileForm', 'resetForm', 'confirmForm', 'rateForm',
      'catForm', 'rejectForm'
    ]);
    const EMAIL_RE = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    function getErrorNode(field) {
      const key = field.id || field.name || '';
      let node = field.form.querySelector('.js-invalid-feedback[data-for="' + key + '"]');
      if (!node) {
        node = document.createElement('div');
        node.className = 'js-invalid-feedback';
        node.dataset.for = key;
        field.insertAdjacentElement('afterend', node);
      }
      return node;
    }

    function setError(field, message) {
      field.classList.add('is-invalid');
      getErrorNode(field).textContent = message;
    }

    function clearError(field) {
      field.classList.remove('is-invalid');
      const key = field.id || field.name || '';
      const node = field.form.querySelector('.js-invalid-feedback[data-for="' + key + '"]');
      if (node) node.textContent = '';
    }

    function fieldValue(field) {
      if (field.type === 'checkbox') return field.checked ? '1' : '';
      return (field.value || '').trim();
    }

    function isSupportedField(field) {
      return field &&
        !field.disabled &&
        field.type !== 'hidden' &&
        field.type !== 'submit' &&
        field.type !== 'button' &&
        field.type !== 'reset';
    }

    function validateField(field) {
      if (!isSupportedField(field)) return true;

      const value = fieldValue(field);
      const label = field.getAttribute('data-label') || field.getAttribute('aria-label') || field.name || 'This field';

      if (field.required && !value) {
        setError(field, label + ' is required.');
        return false;
      }
      if (field.type === 'email' && value && !EMAIL_RE.test(value)) {
        setError(field, 'Enter a valid email address.');
        return false;
      }
      if (field.getAttribute('minlength') && value.length < Number(field.getAttribute('minlength'))) {
        setError(field, label + ' is too short.');
        return false;
      }
      if (field.getAttribute('maxlength') && value.length > Number(field.getAttribute('maxlength'))) {
        setError(field, label + ' is too long.');
        return false;
      }
      if (field.getAttribute('pattern') && value) {
        const re = new RegExp(field.getAttribute('pattern'));
        if (!re.test(value)) {
          setError(field, 'Please enter a valid value.');
          return false;
        }
      }
      if (field.dataset.match) {
        const target = document.getElementById(field.dataset.match);
        if (target && field.value !== target.value) {
          setError(field, 'Values do not match.');
          return false;
        }
      }
      if (field.type === 'date' && field.dataset.minDate === 'today' && value) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const picked = new Date(value + 'T00:00:00');
        if (picked < today) {
          setError(field, 'Date cannot be in the past.');
          return false;
        }
      }
      if (field.type === 'file' && field.dataset.maxSizeMb && field.files && field.files.length) {
        const maxBytes = Number(field.dataset.maxSizeMb) * 1024 * 1024;
        if (field.files[0].size > maxBytes) {
          setError(field, 'File must be smaller than ' + field.dataset.maxSizeMb + ' MB.');
          return false;
        }
      }

      clearError(field);
      return true;
    }

    document.querySelectorAll('form').forEach(form => {
      if ((form.method || '').toLowerCase() === 'get') return;
      if (form.dataset.jsValidate === 'off') return;
      if (excludedForms.has(form.id)) return;

      form.noValidate = true;
      const fields = Array.from(form.querySelectorAll('input,select,textarea')).filter(isSupportedField);

      fields.forEach(field => {
        const eventName = field.tagName === 'SELECT' || field.type === 'checkbox' || field.type === 'radio'
          ? 'change' : 'blur';
        field.addEventListener(eventName, () => validateField(field));
      });

      form.addEventListener('submit', function (e) {
        let isValid = true;
        let firstInvalid = null;
        fields.forEach(field => {
          const ok = validateField(field);
          if (!ok && !firstInvalid) firstInvalid = field;
          isValid = isValid && ok;
        });
        if (!isValid) {
          e.preventDefault();
          if (firstInvalid) firstInvalid.focus();
          return;
        }
        form.querySelectorAll('button[type="submit"],input[type="submit"]').forEach(btn => {
          const loadingText = btn.getAttribute('data-loading-text');
          if (loadingText) btn.innerHTML = loadingText;
          btn.disabled = true;
        });
      });
    });
  })();
</script>

{% block extra_js %}{% endblock %}
</body>
</html>
