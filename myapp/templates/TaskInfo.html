{% extends "Base.html" %}
{% block title %}Ticket #{{ taskinfos.id }} — HelpDesk{% endblock %}

{% block breadcrumb %}
  <a href="{% url 'base' %}">Dashboard</a>
  <span class="bc-sep">/</span>
  <strong>Ticket #{{ taskinfos.id }}</strong>
{% endblock %}

{% block extra_css %}
<style>
  .ti-grid {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 20px;
    align-items: start;
  }
  @media (max-width: 1100px) { .ti-grid { grid-template-columns: 1fr; } }

  .dr {
    display: flex; align-items: center;
    justify-content: space-between;
    padding: 11px 18px;
    border-bottom: 1px solid var(--slate-100);
    gap: 8px;
    font-size: 13.5px;
  }
  .dr:last-child { border-bottom: none; }
  .dr-label {
    font-size: 12px; color: var(--slate-500);
    font-weight: 600; white-space: nowrap;
    display: flex; align-items: center; gap: 6px;
  }
  .dr-val {
    color: var(--slate-800); font-weight: 500;
    text-align: right; max-width: 180px;
    word-break: break-word;
  }

  .action-grid {
    display: grid; gap: 8px;
  }
  .action-btn {
    display: flex; align-items: center; justify-content: center; gap: 8px;
    padding: 9px 14px; border-radius: var(--r);
    font-size: 13px; font-weight: 600;
    transition: all .15s; text-decoration: none;
    border: 1.5px solid transparent; cursor: pointer;
    font-family: 'DM Sans', sans-serif;
  }
  .action-btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }
  .ab-primary   { background: var(--brand);        color: #fff; border-color: var(--brand); }
  .ab-primary:hover { background: var(--brand-dark); }
  .ab-success   { background: var(--success);      color: #fff; border-color: var(--success); }
  .ab-success:hover { background: #047857; }
  .ab-outline   { background: #fff; color: var(--slate-700); border-color: var(--slate-200); }
  .ab-outline:hover { border-color: var(--slate-400); color: var(--slate-900); background: var(--slate-50); }
  .ab-warning   { background: var(--warning-bg); color: var(--warning); border-color: var(--warning-border); }
  .ab-warning:hover { background: var(--warning); color: #fff; }
  .ab-danger    { background: var(--danger-bg);  color: var(--danger);  border-color: var(--danger-border); }
  .ab-danger:hover  { background: var(--danger);  color: #fff; }

  .ai-assign-row {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 14px;
    background: linear-gradient(90deg, #EEF2FF, #F5F3FF);
    border: 1px solid #C7D2FE;
    border-radius: var(--r);
    font-size: 12.5px; color: var(--slate-700);
    margin-bottom: 12px;
  }

  .reject-modal-backdrop {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,.45); z-index: 2000;
    align-items: center; justify-content: center;
  }
  .reject-modal-backdrop.show { display: flex; }
  .reject-modal {
    background: #fff; border-radius: var(--r-lg);
    padding: 28px; max-width: 440px; width: 90%;
    box-shadow: var(--shadow-lg);
    animation: popIn .2s ease;
  }
  @keyframes popIn { from { transform: scale(.94); opacity:0; } to { transform: scale(1); opacity:1; } }
  .rm-title { font-size: 16px; font-weight: 700; color: var(--slate-900); margin-bottom: 6px; }
  .rm-sub   { font-size: 13px; color: var(--slate-500); margin-bottom: 18px; }

  .comment-item {
    padding: 16px 20px;
    border-bottom: 1px solid var(--slate-100);
  }
  .comment-item:last-child { border-bottom: none; }

</style>
{% endblock %}

{% block content %}
<div class="ti-grid">

  <div>

    <div class="hd-card mb-4">
      <div class="hd-card-body">

        <div class="d-flex align-items-center gap-2 flex-wrap mb-3">
          <span class="mono" style="font-size:12px;color:var(--slate-400);">
            TICKET #{{ taskinfos.id }}
          </span>
          {% if taskinfos.assignment_type == 'AUTO_AI' or taskinfos.assignment_type == 'AUTO_ML' %}
          <span class="ai-badge"><i class="fas fa-robot"></i> AI Routed</span>
          {% endif %}
        </div>

        <h1 style="font-size:20px;font-weight:700;color:var(--slate-900);
                   letter-spacing:-.3px;line-height:1.35;margin-bottom:16px;">
          {{ taskinfos.TASK_TITLE }}
        </h1>

        <div class="d-flex flex-wrap gap-2 align-items-center mb-4">
          <span class="status-badge
            {% if taskinfos.TASK_STATUS == 'Open'         %}sb-open
            {% elif taskinfos.TASK_STATUS == 'In Progress'%}sb-progress
            {% elif taskinfos.TASK_STATUS == 'Closed'     %}sb-closed
            {% elif taskinfos.TASK_STATUS == 'Resolved'   %}sb-resolved
            {% elif taskinfos.TASK_STATUS == 'Reopen'     %}sb-reopen
            {% else %}sb-expired{% endif %}">
            {{ taskinfos.TASK_STATUS }}
          </span>

          {% if taskinfos.priority %}
          <span class="priority-badge
            {% if taskinfos.priority == 'LOW'     %}pb-low
            {% elif taskinfos.priority == 'MEDIUM'%}pb-medium
            {% elif taskinfos.priority == 'HIGH'  %}pb-high
            {% else %}pb-urgent{% endif %}">
            <i class="fas fa-flag" style="font-size:9px;"></i>
            {{ taskinfos.get_priority_display }}
          </span>
          {% endif %}

          {% if taskinfos.is_overdue %}
          <span style="background:var(--danger-bg);color:var(--danger);border:1px solid var(--danger-border);
                       font-size:11px;font-weight:700;padding:3px 9px;border-radius:20px;">
            <i class="fas fa-exclamation-triangle"></i> Overdue
          </span>
          {% endif %}

          {% if taskinfos.category %}
          <span style="font-size:11px;font-weight:700;padding:3px 9px;border-radius:20px;
                       background:{{ taskinfos.category.color }}18;color:{{ taskinfos.category.color }};
                       border:1px solid {{ taskinfos.category.color }}40;">
            <i class="{{ taskinfos.category.icon }}"></i> {{ taskinfos.category.name }}
          </span>
          {% endif %}
        </div>

        <div class="d-flex flex-wrap gap-2">
          {% if creator_edit_only_mode and can_edit_task %}
          <a href="{% url 'updatetask' taskinfos.id %}?mine_only=1" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-edit me-1"></i>Edit
          </a>
          {% elif can_edit_task and not request.GET.from_assigned %}
          <a href="{% url 'updatetask' taskinfos.id %}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-edit me-1"></i>Edit
          </a>

          {% if taskinfos.TASK_STATUS not in 'Closed,Resolved,Expired' and can_work_on_task %}
          <a href="{% url 'comment' pk=taskinfos.id action='closing_comment' %}"
             class="btn btn-sm btn-outline-success">
            <i class="fas fa-check-double me-1"></i>Close with Note
          </a>
          {% endif %}

          {% if taskinfos.TASK_STATUS == 'Closed' %}
            {% if can_reopen_ticket and is_admin or can_reopen_ticket and taskinfos.TASK_CREATED == request.user and can_work_on_task %}
            <a href="{% url 'comment' pk=taskinfos.id action='reopen_comment' %}"
               class="btn btn-sm btn-outline-warning">
              <i class="fas fa-redo me-1"></i>Reopen
            </a>
            {% endif %}
          {% endif %}

          {% if taskinfos.TASK_STATUS not in 'Closed,Resolved,Expired' and can_reject and not request.GET.from_assigned %}
          <a href="{% url 'removetask' taskinfos.id %}" class="btn btn-sm btn-outline-danger">
            <i class="fas fa-times me-1"></i>Reject Assignment
          </a>
          {% endif %}

          {% if not request.GET.from_assigned %}
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
              <i class="fas fa-ellipsis-h me-1"></i>More
            </button>
            <ul class="dropdown-menu dropdown-menu-end"
                style="min-width:210px;border-color:var(--slate-200);border-radius:10px;
                       font-size:13px;padding:6px;">
              {% if taskinfos.TASK_STATUS == 'Closed' or taskinfos.TASK_STATUS == 'Resolved' %}
                {% if taskinfos.TASK_CREATED == request.user %}
                <li>
                  <a class="dropdown-item rounded py-2" href="{% url 'rate_task' taskinfos.id %}">
                    <i class="fas fa-star me-2" style="color:var(--warning);width:14px;"></i>Rate Ticket
                  </a>
                </li>
                {% endif %}
              {% endif %}
              {% if taskinfos.TASK_CREATED == request.user or is_admin %}
              <li><hr class="dropdown-divider my-1"></li>
              <li>
                <a class="dropdown-item rounded py-2 text-danger"
                   href="{% url 'deletetask' taskinfos.id %}"
                   onclick="return confirm('Permanently delete this ticket?')">
                  <i class="fas fa-trash me-2" style="width:14px;"></i>Delete
                </a>
              </li>
              {% endif %}
            </ul>
          </div>
          {% endif %}
          {% endif %}

        </div>

      </div>
    </div>

    <div class="hd-card mb-4">
      <div class="hd-card-header">
        <div class="hd-card-title">
          <i class="fas fa-align-left" style="color:var(--brand);"></i> Description
        </div>
      </div>
      <div class="hd-card-body">
        <p style="font-size:14px;color:var(--slate-700);line-height:1.85;white-space:pre-line;margin:0;">
          {{ normalized_description }}
        </p>
        {% if is_admin %}
        <div style="margin-top:14px;padding-top:12px;border-top:1px solid var(--slate-100);display:grid;gap:8px;">
          <div style="font-size:12.5px;color:var(--slate-700);">
            <i class="fas fa-user-check" style="color:var(--brand);margin-right:5px;"></i>
            <strong>Currently solving:</strong>
            {% if taskinfos.assigned_to %}
              {{ taskinfos.assigned_to.get_full_name|default:taskinfos.assigned_to.username }}
            {% else %}
              Unassigned
            {% endif %}
          </div>
          {% if latest_rejection_reason %}
          <div style="font-size:12.5px;color:#92400E;">
            <i class="fas fa-ban" style="margin-right:5px;"></i>
            <strong>Earlier member rejection:</strong>
            {% if latest_rejection_by %}{{ latest_rejection_by }} - {% endif %}
            {{ latest_rejection_reason }}
          </div>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </div>

    <div class="hd-card">
      <div class="hd-card-header">
        <div class="hd-card-title">
          <i class="fas fa-comments" style="color:var(--brand);"></i>
          Activity
          {% if comments %}
          <span style="background:var(--slate-100);color:var(--slate-600);font-size:11px;
                       font-weight:700;padding:1px 7px;border-radius:20px;margin-left:4px;">
            {{ comments|length }}
          </span>
          {% endif %}
        </div>
      </div>

      {% if can_creator_decide_closed %}
      <div class="hd-card-body" style="border-bottom:1px solid var(--slate-100);">
        <div class="d-flex gap-2 flex-wrap">
          {% if can_reopen_ticket %}
          <a href="{% url 'comment' pk=taskinfos.id action='reopen_comment' %}"
             class="btn btn-sm btn-outline-warning">
            <i class="fas fa-redo me-1"></i>Add Reopening Comment
          </a>
          {% endif %}
          <a href="{% url 'resolvedtask' taskinfos.id %}" class="btn btn-sm btn-outline-success">
            <i class="fas fa-check-circle me-1"></i>Mark as Resolved
          </a>
        </div>
      </div>
      {% endif %}

      {% if can_rate_resolved_task %}
      <div class="hd-card-body" style="border-bottom:1px solid var(--slate-100);">
        <div class="d-flex gap-2 flex-wrap">
          <a href="{% url 'rate_task' taskinfos.id %}" class="btn btn-sm btn-outline-warning">
            <i class="fas fa-star me-1"></i>Rate Task
          </a>
        </div>
      </div>
      {% endif %}

      {% if comments %}
        {% for comment in comments %}
        <div class="comment-item">
          <div class="d-flex gap-3">
            <div class="hd-avatar" style="width:32px;height:32px;font-size:12px;flex-shrink:0;">
              {{ comment.user.username|first|upper }}
            </div>
            <div style="flex:1;min-width:0;">
              <div class="d-flex align-items-center gap-2 flex-wrap mb-2">
                <span style="font-size:13px;font-weight:700;color:var(--slate-800);">
                  {{ comment.user.username }}
                </span>
                <span style="font-size:11.5px;color:var(--slate-400);">
                  {{ comment.created_at|date:"M d, Y · H:i" }}
                </span>
              </div>

              {% if comment.Closing_comment %}
              <div style="background:var(--success-bg);border-left:3px solid var(--success);
                          padding:10px 14px;border-radius:4px;font-size:13.5px;
                          color:var(--slate-700);line-height:1.6;">
                <div style="font-size:10.5px;font-weight:700;color:var(--success);margin-bottom:4px;">
                  <i class="fas fa-check-circle"></i> CLOSING NOTE
                </div>
                {{ comment.Closing_comment }}
              </div>
              {% elif comment.Reopen_comment %}
              <div style="background:var(--warning-bg);border-left:3px solid var(--warning);
                          padding:10px 14px;border-radius:4px;font-size:13.5px;
                          color:var(--slate-700);line-height:1.6;">
                <div style="font-size:10.5px;font-weight:700;color:var(--warning);margin-bottom:4px;">
                  <i class="fas fa-redo"></i> REOPEN NOTE
                </div>
                {{ comment.Reopen_comment }}
              </div>
              {% else %}
              <div style="font-size:13.5px;color:var(--slate-700);line-height:1.65;">
                {{ comment.Comment|default:'' }}
              </div>
              {% endif %}

              {% if comment.TextFile %}
              <div style="margin-top:10px;">
                <a href="{% url 'download_file' comment.id %}"
                   style="display:inline-flex;align-items:center;gap:7px;font-size:12.5px;
                          color:var(--brand);background:var(--brand-light);
                          padding:5px 12px;border-radius:6px;border:1px solid var(--brand-muted);">
                  <i class="fas fa-paperclip"></i> Download Attachment
                </a>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
      <div class="empty-state" style="padding:40px;">
        <div class="empty-icon"><i class="fas fa-comment-slash"></i></div>
        <div class="empty-title">No activity yet</div>
        <div class="empty-text">Comments, status changes and notes will appear here.</div>
      </div>
      {% endif %}

      {% if not creator_edit_only_mode %}
      <div class="hd-card-footer">
        <div class="d-flex gap-2 flex-wrap">
          {% if taskinfos.TASK_STATUS not in 'Closed,Resolved,Expired' %}
          <a href="{% url 'comment' pk=taskinfos.id action='closing_comment' %}"
             class="btn btn-xs btn-outline-success">
            <i class="fas fa-check me-1"></i>Close with Note
          </a>
          {% endif %}
          {% if taskinfos.TASK_STATUS == 'Closed' and can_reopen_ticket and is_admin or taskinfos.TASK_STATUS == 'Closed' and can_reopen_ticket and taskinfos.TASK_CREATED == request.user %}
          <a href="{% url 'comment' pk=taskinfos.id action='reopen_comment' %}"
             class="btn btn-xs btn-outline-warning">
            <i class="fas fa-redo me-1"></i>Reopen
          </a>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>

  </div>

  <div>

    {% if taskinfos.assignment_type == 'AUTO_AI' or taskinfos.assignment_type == 'AUTO_ML' %}
    <div class="ai-assign-row mb-3">
      <i class="fas fa-robot" style="color:var(--brand);font-size:15px;flex-shrink:0;"></i>
      <div>
        <div style="font-weight:700;color:var(--slate-800);font-size:12.5px;">AI-Assigned Ticket</div>
        <div style="color:var(--slate-500);font-size:12px;">
          Routed by AI
          {% if taskinfos.ml_confidence_score %}
            · {{ taskinfos.ml_confidence_score|floatformat:0 }}% confidence
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

    <div class="hd-card mb-3">
      <div class="hd-card-header">
        <div class="hd-card-title">Ticket Details</div>
      </div>

      <div class="dr">
        <span class="dr-label"><i class="fas fa-user"></i> Reported By</span>
        <span class="dr-val">{{ taskinfos.TASK_CREATED.username }}</span>
      </div>
      <div class="dr">
        <span class="dr-label"><i class="fas fa-calendar-alt"></i> Created</span>
        <span class="dr-val">{{ taskinfos.TASK_CREATED_ON|date:"M d, Y" }}</span>
      </div>
      <div class="dr">
        <span class="dr-label"><i class="fas fa-calendar-check"></i> Due Date</span>
        <span class="dr-val" style="{% if taskinfos.is_overdue %}color:var(--danger);font-weight:700;{% endif %}">
          {{ taskinfos.TASK_DUE_DATE|date:"M d, Y" }}
          {% if taskinfos.is_overdue %}<i class="fas fa-exclamation-circle ms-1" style="font-size:10px;"></i>{% endif %}
        </span>
      </div>

      {% if taskinfos.assigned_department %}
      <div class="dr">
        <span class="dr-label"><i class="fas fa-building"></i> Department</span>
        <span class="dr-val" style="font-weight:700;color:{{ taskinfos.assigned_department.color|default:'var(--brand)' }};">
          {{ taskinfos.assigned_department.name }}
        </span>
      </div>
      {% endif %}

      {% if taskinfos.assigned_to %}
      <div class="dr">
        <span class="dr-label"><i class="fas fa-user-check"></i> Assigned To</span>
        <span class="dr-val">
          <div class="d-flex align-items-center gap-2 justify-content-end">
            <div class="hd-avatar" style="width:22px;height:22px;font-size:10px;">
              {{ taskinfos.assigned_to.username|first|upper }}
            </div>
            {{ taskinfos.assigned_to.get_full_name|default:taskinfos.assigned_to.username }}
          </div>
        </span>
      </div>
      {% else %}
      <div class="dr">
        <span class="dr-label"><i class="fas fa-user-check"></i> Assigned To</span>
        <span class="dr-val" style="color:var(--slate-400);">Pending AI</span>
      </div>
      {% endif %}
      {% if taskinfos.TASK_CLOSED_ON %}
      <div class="dr">
        <span class="dr-label"><i class="fas fa-times-circle"></i> Closed On</span>
        <span class="dr-val">{{ taskinfos.TASK_CLOSED_ON|date:"M d, Y" }}</span>
      </div>
      {% endif %}
    </div>

    {% if can_view_admin_note_thread %}
    <div class="hd-card mb-3">
      <div class="hd-card-header">
        <div class="hd-card-title">
          <i class="fas fa-sticky-note" style="color:var(--warning);"></i>
          Overdue Note Thread
        </div>
      </div>
      <div class="hd-card-body" style="padding-top:12px;">
        {% if overdue_note_thread %}
          {% for item in overdue_note_thread %}
          <div style="margin-bottom:10px;padding:10px 12px;border-radius:8px;
                      border:1px solid {% if item.field_name == 'admin_overdue_note' %}#FCD34D{% else %}var(--slate-200){% endif %};
                      background:{% if item.field_name == 'admin_overdue_note' %}#FFFBEB{% else %}var(--slate-50){% endif %};">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px;">
              <span style="font-size:11px;font-weight:700;color:var(--slate-700);">
                {% if item.field_name == 'admin_overdue_note' %}Admin Note{% else %}Member Reply{% endif %}
                · {{ item.changed_by.username|default:'System' }}
              </span>
              <span style="font-size:11px;color:var(--slate-400);">{{ item.changed_at|date:"M d, Y · H:i" }}</span>
            </div>
            <div style="font-size:13px;color:var(--slate-700);line-height:1.6;white-space:pre-line;">
              {{ item.new_value }}
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div style="font-size:13px;color:var(--slate-400);font-style:italic;">No overdue notes yet.</div>
        {% endif %}

        {% if can_reply_admin_overdue_note %}
        <form method="POST" action="{% url 'reply_overdue_note' taskinfos.id %}" style="margin-top:12px;">
          {% csrf_token %}
          <label for="overdueReply" class="form-label" style="font-size:12px;font-weight:700;">Reply to Admin</label>
          <textarea id="overdueReply" name="overdue_note_reply" class="form-control mb-2" rows="3"
                    placeholder="Update admin on progress for this overdue task." required minlength="3"></textarea>
          <button type="submit" class="btn btn-sm btn-outline-primary">
            <i class="fas fa-reply me-1"></i>Send Reply
          </button>
        </form>
        {% endif %}
      </div>
    </div>
    {% endif %}

    {% if not creator_edit_only_mode %}
    <div class="hd-card-body action-grid">
      {% if is_admin and taskinfos.is_overdue and taskinfos.TASK_STATUS != 'Closed' and taskinfos.TASK_STATUS != 'Resolved' %}
      <form method="POST" action="{% url 'send_overdue_note' taskinfos.id %}" class="mb-2">
        {% csrf_token %}
        <label for="overdueNote" class="form-label" style="font-size:12px;font-weight:700;">Admin Note For Overdue Ticket</label>
        <textarea id="overdueNote" name="overdue_note" class="form-control mb-2" rows="3"
                  placeholder="Task is overdue. Please complete it as soon as possible."
                  required minlength="8" data-label="Overdue note"></textarea>
        <button type="submit" class="action-btn ab-warning" style="width:100%;">
          <i class="fas fa-bell"></i> Send Overdue Reminder
        </button>
      </form>
      {% endif %}

      {% if request.GET.from_assigned and taskinfos.TASK_STATUS == 'Reopen' %}
        {% if can_work_on_task %}
        <a href="{% url 'comment' pk=taskinfos.id action='closing_comment' %}" class="action-btn ab-outline">
          <i class="fas fa-times-circle"></i> Close with Note
        </a>
        {% endif %}
      {% elif taskinfos.TASK_STATUS == 'In Progress' or taskinfos.TASK_STATUS == 'Reopen' %}
        {% if can_work_on_task or is_admin %}
        <a href="{% url 'resolvedtask' taskinfos.id %}" class="action-btn ab-success">
          <i class="fas fa-check-circle"></i> Mark Resolved
        </a>
        {% if not is_admin %}
        <a href="{% url 'closetask' taskinfos.id %}" class="action-btn ab-outline">
          <i class="fas fa-times-circle"></i> Close Ticket
        </a>
        {% endif %}
        {% if can_reject %}
        <a href="{% url 'removetask' taskinfos.id %}"
            class="action-btn ab-outline">
          <i class="fas fa-undo"></i> Release Ticket
        </a>
        {% endif %}
        {% endif %}
      {% endif %}

      {% if can_creator_decide_closed %}
      <a href="{% url 'resolvedtask' taskinfos.id %}" class="action-btn ab-success">
        <i class="fas fa-check-circle"></i> Mark Resolved
      </a>
      {% endif %}

      {% if taskinfos.TASK_STATUS == 'Closed' and can_reopen_ticket and is_admin or taskinfos.TASK_STATUS == 'Closed' and can_reopen_ticket and taskinfos.TASK_CREATED == request.user %}
      <a href="{% url 'comment' pk=taskinfos.id action='reopen_comment' %}" class="action-btn ab-warning">
        <i class="fas fa-redo"></i> Reopen Ticket
      </a>
      {% endif %}

      {% if taskinfos.TASK_STATUS == 'Closed' or taskinfos.TASK_STATUS == 'Resolved' %}
        {% if taskinfos.TASK_CREATED == request.user %}
        <a href="{% url 'rate_task' taskinfos.id %}" class="action-btn ab-outline">
          <i class="fas fa-star"></i> Rate This Ticket
        </a>
        {% endif %}
      {% endif %}

    </div>
    {% endif %}
  </div>
</div>

{% if can_reject and not creator_edit_only_mode %}
<div class="reject-modal-backdrop" id="rejectModalBackdrop">
  <div class="reject-modal">
    <div class="rm-title"><i class="fas fa-times-circle me-2" style="color:var(--danger);"></i>Reject This Assignment</div>
    <div class="rm-sub">
      Tell the system why you can't handle this ticket. It will be reassigned to another available admin.
    </div>
    <form method="POST" action="{% url 'reject_task' taskinfos.id %}" id="rejectForm">
      {% csrf_token %}
      <div class="mb-3">
        <label class="form-label">Reason <span class="text-danger">*</span></label>
        <textarea name="reject_reason" id="rejectReason" class="form-control" rows="3"
                  placeholder="e.g. Out of my area of expertise, currently at capacity…"
                  style="resize:vertical;"></textarea>
        <div class="field-error" id="rejectErr" style="display:none;">Please provide a reason.</div>
      </div>
      <div class="d-flex gap-2 justify-content-end">
        <button type="button" class="btn btn-outline-secondary btn-sm"
                onclick="closeRejectModal()">Cancel</button>
        <button type="submit" class="btn btn-danger btn-sm" onclick="return validateReject(event)">
          <i class="fas fa-times me-1"></i>Confirm Rejection
        </button>
      </div>
    </form>
  </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
  function openRejectModal()  {
    document.getElementById('rejectModalBackdrop').classList.add('show');
    document.body.style.overflow = 'hidden';
  }
  function closeRejectModal() {
    document.getElementById('rejectModalBackdrop').classList.remove('show');
    document.body.style.overflow = '';
  }

  const rejectBackdrop = document.getElementById('rejectModalBackdrop');
  if (rejectBackdrop) {
    rejectBackdrop.addEventListener('click', function(e) {
      if (e.target === this) closeRejectModal();
    });
  }

  function validateReject(e) {
    const reasonEl = document.getElementById('rejectReason');
    const reason = reasonEl ? reasonEl.value.trim() : '';
    const err    = document.getElementById('rejectErr');
    if (!reason) {
      err.style.display = 'block';
      e.preventDefault();
      return false;
    }
    err.style.display = 'none';
    return true;
  }
</script>
{% endblock %}




