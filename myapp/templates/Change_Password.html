{% extends "Base.html" %}
{% block title %}Change Password — HelpDesk{% endblock %}

{% block breadcrumb %}
  <a href="{% url 'profile' %}">My Profile</a>
  <span class="bc-sep">/</span>
  <strong>Change Password</strong>
{% endblock %}

{% block extra_css %}
<style>
  .pw-wrap { max-width: 500px; margin: 0 auto; }

  .pw-field-wrap { position: relative; }
  .pw-field-wrap input { padding-left: 36px; padding-right: 44px; width: 100%; }
  .pw-prefix-icon {
    position: absolute; left: 12px; top: 50%;
    transform: translateY(-50%);
    color: var(--slate-400); font-size: 13px; pointer-events: none;
  }
  .pw-toggle {
    position: absolute; right: 12px; top: 50%;
    transform: translateY(-50%);
    color: var(--slate-400); font-size: 13px;
    cursor: pointer; background: none; border: none; padding: 0;
    transition: color .15s;
  }
  .pw-toggle:hover { color: var(--brand); }

  .strength-track {
    height: 5px; background: var(--slate-100);
    border-radius: 4px; overflow: hidden; margin-top: 8px;
    display: flex; gap: 3px;
  }
  .strength-seg {
    flex: 1; height: 100%; border-radius: 3px;
    background: var(--slate-200); transition: background .3s;
  }
  .strength-label {
    font-size: 11.5px; font-weight: 700; margin-top: 5px;
    min-height: 17px; transition: color .2s;
  }

  .req-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 6px; }
  .req-item {
    display: flex; align-items: center; gap: 8px;
    font-size: 12.5px; color: var(--slate-500);
    transition: color .2s;
  }
  .req-icon {
    width: 16px; height: 16px; border-radius: 50%;
    border: 1.5px solid var(--slate-300);
    display: flex; align-items: center; justify-content: center;
    font-size: 8px; color: transparent; flex-shrink: 0;
    transition: all .2s;
  }
  .req-item.pass { color: var(--success); }
  .req-item.pass .req-icon {
    background: var(--success); border-color: var(--success);
    color: #fff;
  }
  .req-item.fail .req-icon {
    border-color: var(--danger); background: var(--danger-bg);
    color: var(--danger);
  }

  .confirm-status {
    font-size: 11.5px; font-weight: 600;
    margin-top: 5px; min-height: 17px;
    display: flex; align-items: center; gap: 5px;
    transition: color .2s;
  }
</style>
{% endblock %}

{% block content %}
<div class="pw-wrap">

  <div class="page-header">
    <div class="page-title">Change Password</div>
    <div class="page-sub">Choose a strong password to keep your account secure</div>
  </div>

  <div class="hd-card">
    <div class="hd-card-header">
      <div class="hd-card-title">
        <i class="fas fa-key" style="color:var(--brand);"></i>
        Update Your Password
      </div>
    </div>

    <form method="POST" id="pwForm" novalidate>
      {% csrf_token %}
      <div class="hd-card-body">

        <div class="mb-4">
          <label class="form-label">Current Password <span class="text-danger">*</span></label>
          <div class="pw-field-wrap">
            <i class="fas fa-lock pw-prefix-icon"></i>
            {{ fm.old_password }}
            <button type="button" class="pw-toggle" onclick="toggleVis('id_old_password', this)">
              <i class="fas fa-eye"></i>
            </button>
          </div>
          {% if fm.old_password.errors %}
            <div class="field-error">{{ fm.old_password.errors.0 }}</div>
          {% endif %}
          <div class="field-error" id="err_old" style="display:none;">Current password is required.</div>
        </div>

        <div style="height:1px;background:var(--slate-100);margin:0 0 20px;"></div>

        <div class="mb-3">
          <label class="form-label">New Password <span class="text-danger">*</span></label>
          <div class="pw-field-wrap">
            <i class="fas fa-lock-open pw-prefix-icon"></i>
            {{ fm.new_password1 }}
            <button type="button" class="pw-toggle" onclick="toggleVis('id_new_password1', this)">
              <i class="fas fa-eye"></i>
            </button>
          </div>
          {% if fm.new_password1.errors %}
            <div class="field-error">{{ fm.new_password1.errors.0 }}</div>
          {% endif %}

          <div class="strength-track" id="strengthTrack">
            <div class="strength-seg" id="seg1"></div>
            <div class="strength-seg" id="seg2"></div>
            <div class="strength-seg" id="seg3"></div>
            <div class="strength-seg" id="seg4"></div>
          </div>
          <div class="strength-label" id="strengthLabel"></div>
        </div>

        <div style="background:var(--slate-50);border:1px solid var(--slate-200);
                    border-radius:var(--r-lg);padding:14px 16px;margin-bottom:20px;">
          <div style="font-size:11px;font-weight:800;color:var(--slate-500);
                      text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px;">
            <i class="fas fa-shield-alt me-1" style="color:var(--brand);"></i>
            Password Requirements
          </div>
          <ul class="req-list">
            <li class="req-item" id="req_len">
              <span class="req-icon"><i class="fas fa-check"></i></span>
              At least <strong>8 characters</strong>
            </li>
            <li class="req-item" id="req_upper">
              <span class="req-icon"><i class="fas fa-check"></i></span>
              Contains an uppercase letter
            </li>
            <li class="req-item" id="req_num">
              <span class="req-icon"><i class="fas fa-check"></i></span>
              Contains a number
            </li>
            <li class="req-item" id="req_special">
              <span class="req-icon"><i class="fas fa-check"></i></span>
              Contains a special character
            </li>
          </ul>
        </div>

        <div class="mb-2">
          <label class="form-label">Confirm New Password <span class="text-danger">*</span></label>
          <div class="pw-field-wrap">
            <i class="fas fa-check-circle pw-prefix-icon"></i>
            {{ fm.new_password2 }}
            <button type="button" class="pw-toggle" onclick="toggleVis('id_new_password2', this)">
              <i class="fas fa-eye"></i>
            </button>
          </div>
          {% if fm.new_password2.errors %}
            <div class="field-error">{{ fm.new_password2.errors.0 }}</div>
          {% endif %}
          <div class="confirm-status" id="confirmStatus"></div>
        </div>

      </div>

      <div class="hd-card-footer d-flex justify-content-between align-items-center flex-wrap gap-2">
        <a href="{% url 'profile' %}" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left me-1"></i>Back to Profile
        </a>
        <button type="submit" class="btn btn-primary px-4" id="pwSubmitBtn">
          <i class="fas fa-save me-2"></i>Update Password
        </button>
      </div>

    </form>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
  
  function toggleVis(fieldId, btn) {
    const input = document.getElementById(fieldId);
    const icon  = btn.querySelector('i');
    if (input.type === 'password') {
      input.type = 'text';
      icon.className = 'fas fa-eye-slash';
    } else {
      input.type = 'password';
      icon.className = 'fas fa-eye';
    }
  }

  const newPw1       = document.getElementById('id_new_password1');
  const segs         = [1,2,3,4].map(n => document.getElementById('seg' + n));
  const strengthLbl  = document.getElementById('strengthLabel');
  const COLORS = ['#EF4444','#F59E0B','#4F46E5','#10B981'];
  const LABELS = ['Weak','Fair','Good','Strong'];

  const reqs = {
    req_len:     pw => pw.length >= 8,
    req_upper:   pw => /[A-Z]/.test(pw),
    req_num:     pw => /[0-9]/.test(pw),
    req_special: pw => /[^A-Za-z0-9]/.test(pw),
  };

  function calcStrength(pw) {
    return Object.values(reqs).filter(fn => fn(pw)).length;
  }

  function updateStrength() {
    const pw    = newPw1 ? newPw1.value : '';
    const score = pw ? calcStrength(pw) : 0;

    segs.forEach((seg, i) => {
      seg.style.background = i < score ? COLORS[score - 1] : 'var(--slate-200)';
    });

    if (pw && score > 0) {
      strengthLbl.textContent = LABELS[score - 1];
      strengthLbl.style.color = COLORS[score - 1];
    } else {
      strengthLbl.textContent = '';
    }

    Object.entries(reqs).forEach(([id, fn]) => {
      const item = document.getElementById(id);
      if (!item) return;
      item.classList.toggle('pass', !!pw && fn(pw));
      item.classList.toggle('fail', !!pw && !fn(pw));
    });

    updateConfirm();
  }

  const newPw2      = document.getElementById('id_new_password2');
  const confirmStat = document.getElementById('confirmStatus');

  function updateConfirm() {
    const pw1 = newPw1 ? newPw1.value : '';
    const pw2 = newPw2 ? newPw2.value : '';
    if (!pw2) { confirmStat.innerHTML = ''; return; }
    if (pw1 === pw2) {
      confirmStat.style.color = 'var(--success)';
      confirmStat.innerHTML   = '<i class="fas fa-check-circle"></i> Passwords match';
    } else {
      confirmStat.style.color = 'var(--danger)';
      confirmStat.innerHTML   = '<i class="fas fa-times-circle"></i> Passwords do not match';
    }
  }

  if (newPw1) newPw1.addEventListener('input', updateStrength);
  if (newPw2) newPw2.addEventListener('input', updateConfirm);

  document.getElementById('pwForm').addEventListener('submit', function(e) {
    let valid = true;

    const old = document.getElementById('id_old_password');
    const errOld = document.getElementById('err_old');
    if (old && !old.value.trim()) {
      old.classList.add('is-invalid'); errOld.style.display = 'block'; valid = false;
    } else if (old) { old.classList.remove('is-invalid'); errOld.style.display = 'none'; }

    const pw1 = newPw1 ? newPw1.value : '';
    const pw2 = newPw2 ? newPw2.value : '';
    if (pw1 && pw2 && pw1 !== pw2) { valid = false; }

    if (!valid) { e.preventDefault(); return; }

    const btn = document.getElementById('pwSubmitBtn');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating…';
    btn.disabled  = true;
  });
</script>
{% endblock %}