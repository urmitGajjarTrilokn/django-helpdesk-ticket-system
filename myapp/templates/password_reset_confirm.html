{% extends "Base.html" %}
{% block title %}Set New Password — HelpDesk{% endblock %}

{% block extra_css %}
<style>
  .auth-outer {
    min-height: calc(100vh - 160px);
    display: flex; align-items: center; justify-content: center;
    padding: 32px 16px;
  }
  .auth-card-wrap { width: 100%; max-width: 440px; }
  .auth-card {
    background: #fff;
    border: 1px solid var(--slate-200);
    border-radius: var(--r-lg);
    box-shadow: 0 8px 32px rgba(0,0,0,.07);
    overflow: hidden;
  }

  .auth-head {
    padding: 36px 32px 24px; text-align: center;
    border-bottom: 1px solid var(--slate-100);
  }
  .auth-icon-ring {
    width: 68px; height: 68px; border-radius: 50%;
    background: var(--brand-light); border: 2px solid var(--brand-muted);
    display: flex; align-items: center; justify-content: center;
    font-size: 26px; color: var(--brand); margin: 0 auto 18px;
    animation: popIn .5s cubic-bezier(.34,1.56,.64,1) both;
  }

  .invalid-head {
    background: linear-gradient(135deg, #DC2626 0%, #EF4444 100%);
    padding: 40px 32px 32px; text-align: center; position: relative; overflow: hidden;
  }
  .invalid-head::before {
    content: '';
    position: absolute; inset: 0;
    background: radial-gradient(ellipse at 70% 20%, rgba(255,255,255,.1) 0%, transparent 55%);
  }
  .invalid-icon-ring {
    width: 80px; height: 80px; border-radius: 50%;
    background: rgba(255,255,255,.2); border: 2.5px solid rgba(255,255,255,.3);
    display: flex; align-items: center; justify-content: center;
    font-size: 34px; color: #fff; margin: 0 auto 18px;
    animation: popIn .5s cubic-bezier(.34,1.56,.64,1) both;
    position: relative;
  }

  .auth-body { padding: 26px 32px; }

  .pw-field-wrap { position: relative; }
  .pw-field-wrap input { padding-left: 36px; padding-right: 44px; width: 100%; }
  .pw-prefix-icon {
    position: absolute; left: 12px; top: 50%;
    transform: translateY(-50%);
    color: var(--slate-400); font-size: 13px; pointer-events: none;
  }
  .pw-toggle {
    position: absolute; right: 12px; top: 50%;
    transform: translateY(-50%);
    background: none; border: none; padding: 0;
    color: var(--slate-400); font-size: 13px; cursor: pointer;
    transition: color .15s;
  }
  .pw-toggle:hover { color: var(--brand); }

  .strength-track {
    height: 5px; background: var(--slate-100); border-radius: 4px;
    overflow: hidden; margin-top: 8px; display: flex; gap: 3px;
  }
  .strength-seg { flex: 1; height: 100%; border-radius: 3px; background: var(--slate-200); transition: background .3s; }
  .strength-label { font-size: 11.5px; font-weight: 700; margin-top: 5px; min-height: 17px; }

  .req-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 6px; }
  .req-item { display: flex; align-items: center; gap: 8px; font-size: 12.5px; color: var(--slate-500); transition: color .2s; }
  .req-icon {
    width: 16px; height: 16px; border-radius: 50%;
    border: 1.5px solid var(--slate-300);
    display: flex; align-items: center; justify-content: center;
    font-size: 8px; color: transparent; flex-shrink: 0; transition: all .2s;
  }
  .req-item.pass { color: var(--success); }
  .req-item.pass .req-icon { background: var(--success); border-color: var(--success); color: #fff; }

  .confirm-status {
    font-size: 11.5px; font-weight: 600; margin-top: 5px;
    min-height: 17px; display: flex; align-items: center; gap: 5px;
  }

  @keyframes popIn {
    0%   { transform: scale(0);    opacity: 0; }
    60%  { transform: scale(1.12); }
    100% { transform: scale(1);    opacity: 1; }
  }
</style>
{% endblock %}

{% block content %}
<div class="auth-outer">
<div class="auth-card-wrap">

  {% if validlink %}

  <div class="auth-card">
    <div class="auth-head">
      <div class="auth-icon-ring"><i class="fas fa-lock-open"></i></div>
      <div style="font-size:21px;font-weight:800;color:var(--slate-900);letter-spacing:-.3px;margin-bottom:6px;">
        Set New Password
      </div>
      <div style="font-size:13.5px;color:var(--slate-500);">
        Choose a strong, unique password for your account
      </div>
    </div>

    <form method="POST" id="confirmForm" novalidate>
      {% csrf_token %}
      <div class="auth-body">

        <div class="mb-3">
          <label class="form-label">New Password <span class="text-danger">*</span></label>
          <div class="pw-field-wrap">
            <i class="fas fa-key pw-prefix-icon"></i>
            {{ form.new_password1 }}
            <button type="button" class="pw-toggle" onclick="toggleVis('id_new_password1', this)">
              <i class="fas fa-eye"></i>
            </button>
          </div>
          {% if form.new_password1.errors %}
            <div class="field-error">{{ form.new_password1.errors.0 }}</div>
          {% endif %}

          <div class="strength-track" id="strengthTrack">
            <div class="strength-seg" id="seg1"></div>
            <div class="strength-seg" id="seg2"></div>
            <div class="strength-seg" id="seg3"></div>
            <div class="strength-seg" id="seg4"></div>
          </div>
          <div class="strength-label" id="strengthLabel"></div>
        </div>

        <div style="background:var(--slate-50);border:1px solid var(--slate-200);
                    border-radius:var(--r-lg);padding:14px 16px;margin-bottom:20px;">
          <div style="font-size:11px;font-weight:800;text-transform:uppercase;
                      letter-spacing:.5px;color:var(--slate-500);margin-bottom:10px;">
            <i class="fas fa-shield-alt me-1" style="color:var(--brand);"></i> Requirements
          </div>
          <ul class="req-list">
            <li class="req-item" id="req_len">
              <span class="req-icon"><i class="fas fa-check"></i></span>At least <strong>8 characters</strong>
            </li>
            <li class="req-item" id="req_upper">
              <span class="req-icon"><i class="fas fa-check"></i></span>Contains an uppercase letter
            </li>
            <li class="req-item" id="req_num">
              <span class="req-icon"><i class="fas fa-check"></i></span>Contains a number
            </li>
            <li class="req-item" id="req_special">
              <span class="req-icon"><i class="fas fa-check"></i></span>Contains a special character
            </li>
          </ul>
        </div>

        <div class="mb-2">
          <label class="form-label">Confirm Password <span class="text-danger">*</span></label>
          <div class="pw-field-wrap">
            <i class="fas fa-check-circle pw-prefix-icon"></i>
            {{ form.new_password2 }}
            <button type="button" class="pw-toggle" onclick="toggleVis('id_new_password2', this)">
              <i class="fas fa-eye"></i>
            </button>
          </div>
          {% if form.new_password2.errors %}
            <div class="field-error">{{ form.new_password2.errors.0 }}</div>
          {% endif %}
          <div class="confirm-status" id="confirmStatus"></div>
        </div>

        <div class="mt-4">
          <button type="submit" class="btn btn-primary w-100" id="confirmBtn"
                  style="padding:12px;font-weight:700;font-size:14px;">
            <i class="fas fa-check-circle me-2"></i>Set New Password
          </button>
        </div>

      </div>
    </form>

    <div style="padding:12px 32px;border-top:1px solid var(--slate-100);
                text-align:center;font-size:12px;color:var(--slate-400);">
      <i class="fas fa-info-circle me-1"></i>
      After setting, you'll be signed in automatically
    </div>
  </div>

  <div class="auth-card mt-3">
    <div style="display:flex;align-items:center;gap:14px;padding:15px 20px;">
      <div style="width:38px;height:38px;border-radius:50%;flex-shrink:0;
                  background:var(--success-bg);border:1px solid var(--success-border);
                  display:flex;align-items:center;justify-content:center;
                  font-size:15px;color:var(--success);">
        <i class="fas fa-shield-alt"></i>
      </div>
      <div style="font-size:12.5px;color:var(--slate-500);line-height:1.5;">
        Your password is encrypted using industry-standard hashing.
        It is never stored in plain text or shared with anyone.
      </div>
    </div>
  </div>

  {% else %}

  <div class="auth-card">
    <div class="invalid-head">
      <div class="invalid-icon-ring"><i class="fas fa-unlink"></i></div>
      <div style="font-size:21px;font-weight:800;color:#fff;letter-spacing:-.2px;margin-bottom:6px;position:relative;">
        Invalid Reset Link
      </div>
      <div style="font-size:13.5px;color:rgba(255,255,255,.75);position:relative;">
        This link is no longer valid
      </div>
    </div>

    <div style="padding:28px 32px;text-align:center;">
      <div style="width:52px;height:52px;border-radius:50%;margin:0 auto 14px;
                  background:var(--danger-bg);border:1px solid var(--danger-border);
                  display:flex;align-items:center;justify-content:center;
                  font-size:20px;color:var(--danger);">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <div style="font-size:15px;font-weight:700;color:var(--slate-800);margin-bottom:10px;">
        Password Reset Link Invalid
      </div>
      <div style="font-size:13.5px;color:var(--slate-500);line-height:1.7;
                  max-width:340px;margin:0 auto 22px;">
        This link has already been used or has expired. Reset links are only valid for
        <strong style="color:var(--slate-700);">24 hours</strong>.
      </div>

      <div style="background:var(--slate-50);border:1px solid var(--slate-200);
                  border-radius:var(--r-lg);padding:14px 16px;margin-bottom:22px;text-align:left;">
        <div style="font-size:12px;font-weight:700;color:var(--slate-500);margin-bottom:7px;">
          <i class="fas fa-question-circle me-1"></i> What to do
        </div>
        <div style="font-size:13px;color:var(--slate-600);line-height:1.6;">
          Request a fresh password reset — a new link will be sent to your email immediately.
        </div>
      </div>

      <div class="d-grid gap-2">
        <a href="{% url 'password_reset' %}" class="btn btn-primary"
           style="padding:12px;font-weight:700;font-size:14px;">
          <i class="fas fa-redo me-2"></i>Request New Reset Link
        </a>
        <a href="{% url 'login' %}" class="btn btn-outline-secondary"
           style="padding:11px;font-size:13.5px;">
          <i class="fas fa-arrow-left me-2"></i>Back to Login
        </a>
      </div>
    </div>
  </div>

  {% endif %}

</div>
</div>
{% endblock %}

{% block extra_js %}
{% if validlink %}
<script>
  function toggleVis(id, btn) {
    const input = document.getElementById(id);
    const icon  = btn.querySelector('i');
    if (input.type === 'password') { input.type = 'text'; icon.className = 'fas fa-eye-slash'; }
    else { input.type = 'password'; icon.className = 'fas fa-eye'; }
  }

  const pw1 = document.getElementById('id_new_password1');
  const pw2 = document.getElementById('id_new_password2');
  const segs = [1,2,3,4].map(n => document.getElementById('seg' + n));
  const strengthLbl = document.getElementById('strengthLabel');
  const COLORS = ['#EF4444','#F59E0B','#4F46E5','#10B981'];
  const LABELS = ['Weak','Fair','Good','Strong'];

  const reqs = {
    req_len:     pw => pw.length >= 8,
    req_upper:   pw => /[A-Z]/.test(pw),
    req_num:     pw => /[0-9]/.test(pw),
    req_special: pw => /[^A-Za-z0-9]/.test(pw),
  };

  function updateStrength() {
    const pw = pw1 ? pw1.value : '';
    const score = pw ? Object.values(reqs).filter(fn => fn(pw)).length : 0;
    segs.forEach((seg, i) => { seg.style.background = i < score ? COLORS[score-1] : 'var(--slate-200)'; });
    strengthLbl.textContent = pw && score > 0 ? LABELS[score-1] : '';
    strengthLbl.style.color = COLORS[score-1] || '';

    Object.entries(reqs).forEach(([id, fn]) => {
      const item = document.getElementById(id);
      if (!item) return;
      item.classList.toggle('pass', !!pw && fn(pw));
    });
    updateConfirm();
  }

  function updateConfirm() {
    const v1 = pw1 ? pw1.value : '';
    const v2 = pw2 ? pw2.value : '';
    const el = document.getElementById('confirmStatus');
    if (!v2) { el.innerHTML = ''; return; }
    if (v1 === v2) { el.style.color = 'var(--success)'; el.innerHTML = '<i class="fas fa-check-circle"></i> Passwords match'; }
    else           { el.style.color = 'var(--danger)';  el.innerHTML = '<i class="fas fa-times-circle"></i> Passwords do not match'; }
  }

  if (pw1) pw1.addEventListener('input', updateStrength);
  if (pw2) pw2.addEventListener('input', updateConfirm);

  document.getElementById('confirmForm').addEventListener('submit', function(e) {
    if (pw1 && pw2 && pw1.value !== pw2.value) { e.preventDefault(); return; }
    const btn = document.getElementById('confirmBtn');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Setting Password…';
    btn.disabled  = true;
  });
</script>
{% endif %}
{% endblock %}